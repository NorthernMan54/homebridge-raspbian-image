name: Finalize Raspbian Homebridge Image using pi-gen
run-name: Finalize Raspbian Homebridge Image ${{ github.event.inputs.version }} against ${{ github.ref_name }}

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version / Tag (vx.x.x):'     
        required: true

jobs:

  finalize_info:
    name: Prep ${{ github.event.inputs.version }} Info file
    runs-on: [ubuntu-latest]
    steps:
      
    - uses: actions/checkout@v4

    - uses: robinraju/release-downloader@v1.8
      with: 
        
        # The github tag. e.g: v1.0.1
        # Download assets from a specific tag/version
        tag: "${{ github.event.inputs.version }}"
        
        # The name of the file to download.
        # Use this field only to specify filenames other than tarball or zipball, if any.
        # Supports wildcard pattern (eg: '*', '*.deb', '*.zip' etc..)
        fileName: "*.json"

    - uses: robinraju/release-downloader@v1.8
      with: 
        
        # The github tag. e.g: v1.0.1
        # Download assets from a specific tag/version
        tag: "${{ github.event.inputs.version }}"
        
        # The name of the file to download.
        # Use this field only to specify filenames other than tarball or zipball, if any.
        # Supports wildcard pattern (eg: '*', '*.deb', '*.zip' etc..)
        fileName: "*.zip"

    - uses: robinraju/release-downloader@v1.8
      with: 
        
        # The github tag. e.g: v1.0.1
        # Download assets from a specific tag/version
        tag: "${{ github.event.inputs.version }}"
        
        # The name of the file to download.
        # Use this field only to specify filenames other than tarball or zipball, if any.
        # Supports wildcard pattern (eg: '*', '*.deb', '*.zip' etc..)
        fileName: "*.zip,*.json"

    - name: Combine rpi-image-repo JSON's
      run: |
        ./combine-rpi-imager-snipplet.py    

    - name: Upload combined rpi-image-repo ${{ github.event.inputs.version }} 
      uses: AButler/upload-release-assets@v2.0.2
      with:
        files: 'rpi-image-repo.json'
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        release-tag: ${{ github.event.inputs.version }}
 
